<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elegant Box Plot</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f9f9f9;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }

        #chart {
            overflow-x: auto;
        }

        .tooltip {
            position: absolute;
            background: rgba(40, 44, 52, 0.9);
            color: #fff;
            border-radius: 5px;
            padding: 10px;
            font-size: 14px;
            pointer-events: none;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
            z-index: 100;
            line-height: 1.5;
        }

        .axis text {
            font-size: 11px;
            fill: #666;
        }

        .axis line,
        .axis path {
            stroke: #ddd;
        }

        .box {
            fill-opacity: 0.7;
        }

        .median-line {
            stroke-width: 2;
        }

        .point {
            transition: all 0.2s;
        }

        .point:hover {
            r: 5;
        }

        .legend {
            font-size: 12px;
            fill: #555;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Price Distribution Box Plot</h1>
        <div id="chart"></div>
    </div>

    <script>
        // Set dimensions and margins
        const margin = { top: 50, right: 50, bottom: 160, left: 80 },
              width = 1100 - margin.left - margin.right,
              height = 700 - margin.top - margin.bottom;

        // Create SVG container
        const svg = d3.select("#chart")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left}, ${margin.top})`);

        // Create tooltip
        const tooltip = d3.select("body")
            .append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        // Load data
        d3.csv("MC2/cc_data.csv").then(function(data) {
            // Ensure price is numeric
            data.forEach(d => {
                d.price = +d.price;
            });

            // Get list of all locations
            const locations = [...new Set(data.map(d => d.location))];

            // Create X-axis scale
            const x = d3.scaleBand()
                .range([0, width])
                .domain(locations)
                .paddingInner(0.6)
                .paddingOuter(0.4);

            // Add X-axis
            svg.append("g")
                .attr("class", "axis")
                .attr("transform", `translate(0, ${height})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .attr("transform", "translate(-10,0)rotate(-45)")
                .style("text-anchor", "end")
                .style("font-size", "11px");

            // Calculate statistics for each location
            const statsByLocation = d3.rollup(data, v => {
                const prices = v.map(d => d.price).sort(d3.ascending);
                return {
                    q1: d3.quantile(prices, 0.25),
                    median: d3.quantile(prices, 0.5),
                    q3: d3.quantile(prices, 0.75),
                    iqr: d3.quantile(prices, 0.75) - d3.quantile(prices, 0.25),
                    min: d3.min(prices),
                    max: d3.max(prices),
                    // Consider setting outlier ranges
                    lowerOutlier: d3.quantile(prices, 0.25) - 1.5 * (d3.quantile(prices, 0.75) - d3.quantile(prices, 0.25)),
                    upperOutlier: d3.quantile(prices, 0.75) + 1.5 * (d3.quantile(prices, 0.75) - d3.quantile(prices, 0.25)),
                    raw: prices
                };
            }, d => d.location);

            // Convert to array for easier processing
            const statsArray = Array.from(statsByLocation, ([location, stats]) => ({
                location,
                ...stats
            }));

            // Calculate Y-axis range (using log scale)
            const minPrice = d3.min(data, d => d.price) * 0.9;
            const maxPrice = d3.max(data, d => d.price) * 1.1;

            const y = d3.scaleLog()
                .domain([minPrice, maxPrice])
                .range([height, 0]);

            // Add Y-axis
            svg.append("g")
                .attr("class", "axis")
                .call(d3.axisLeft(y)
                    .tickFormat(d => {
                        return d3.format(",.0f")(d);
                    })
                    .tickValues([10, 100, 1000, 10000])
                );

            // Add Y-axis title
            svg.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", -margin.left + 15)
                .attr("x", -height / 2)
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .style("font-size", "14px")
                .style("fill", "#555")
                .text("Price (Log Scale)");

            // Add X-axis title
            svg.append("text")
                .attr("x", width / 2)
                .attr("y", height + margin.bottom - 30)
                .attr("text-anchor", "middle")
                .style("font-size", "14px")
                .style("fill", "#555")
                .text("Locations");

            // Define color scheme
            const colors = d3.scaleOrdinal()
                .domain(locations)
                .range(d3.schemeTableau10);

            // Add vertical lines (from min to max)
            svg.selectAll("vertLines")
                .data(statsArray)
                .enter()
                .append("line")
                .attr("x1", d => x(d.location) + x.bandwidth() / 2)
                .attr("x2", d => x(d.location) + x.bandwidth() / 2)
                .attr("y1", d => y(d.min > minPrice ? d.min : minPrice))
                .attr("y2", d => y(d.max < maxPrice ? d.max : maxPrice))
                .attr("stroke", d => d3.color(colors(d.location)).darker(0.5))
                .attr("stroke-width", 1.5)
                .attr("stroke-opacity", 0.5);

            // Add boxes
            const boxWidth = x.bandwidth() * 0.7;
            svg.selectAll("boxes")
                .data(statsArray)
                .enter()
                .append("rect")
                .attr("class", "box")
                .attr("x", d => x(d.location) + x.bandwidth() / 2 - boxWidth / 2)
                .attr("y", d => y(d.q3))
                .attr("height", d => y(d.q1) - y(d.q3))
                .attr("width", boxWidth)
                .attr("stroke", d => d3.color(colors(d.location)).darker(0.8))
                .attr("stroke-width", 1.5)
                .attr("fill", d => colors(d.location))
                .on("mouseover", function(event, d) {
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", 1);
                    tooltip.html(`
                        <strong>${d.location}</strong><br>
                        Max: ${d.max.toFixed(2)}<br>
                        Q3: ${d.q3.toFixed(2)}<br>
                        Median: ${d.median.toFixed(2)}<br>
                        Q1: ${d.q1.toFixed(2)}<br>
                        Min: ${d.min.toFixed(2)}<br>
                        Sample size: ${d.raw.length}
                    `)
                    .style("left", (event.pageX + 15) + "px")
                    .style("top", (event.pageY - 28) + "px");

                    d3.select(this)
                        .attr("stroke-width", 2)
                        .attr("fill-opacity", 0.9);
                })
                .on("mouseout", function() {
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);

                    d3.select(this)
                        .attr("stroke-width", 1.5)
                        .attr("fill-opacity", 0.7);
                });

            // Add median lines
            svg.selectAll("medianLines")
                .data(statsArray)
                .enter()
                .append("line")
                .attr("class", "median-line")
                .attr("x1", d => x(d.location) + x.bandwidth() / 2 - boxWidth / 2)
                .attr("x2", d => x(d.location) + x.bandwidth() / 2 + boxWidth / 2)
                .attr("y1", d => y(d.median))
                .attr("y2", d => y(d.median))
                .attr("stroke", "#fff")
                .attr("stroke-width", 2);

            // Add violin plot effect - data points scatter plot
            // Add jitter to each point
            const jitter = d3.randomNormal(0, x.bandwidth() / 8);

            svg.selectAll("points")
                .data(data)
                .enter()
                .append("circle")
                .attr("class", "point")
                .attr("cx", d => x(d.location) + x.bandwidth() / 2 + jitter())
                .attr("cy", d => y(d.price))
                .attr("r", 3)
                .attr("fill", d => d3.color(colors(d.location)).darker(0.2))
                .attr("fill-opacity", 0.5)
                .attr("stroke", "#fff")
                .attr("stroke-width", 0.5)
                .on("mouseover", function(event, d) {
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", 1);
                    tooltip.html(`
                        <strong>${d.location}</strong><br>
                        Price: ${d.price.toFixed(2)}<br>
                        Time: ${d.timestamp}<br>
                        Credit Card: ****${d.last4ccnum || ''}
                    `)
                    .style("left", (event.pageX + 15) + "px")
                    .style("top", (event.pageY - 28) + "px");

                    d3.select(this)
                        .attr("r", 5)
                        .attr("stroke-width", 1.5)
                        .attr("fill-opacity", 0.9);
                })
                .on("mouseout", function() {
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);

                    d3.select(this)
                        .attr("r", 3)
                        .attr("stroke-width", 0.5)
                        .attr("fill-opacity", 0.5);
                });

            // Add title
            svg.append("text")
                .attr("x", width / 2)
                .attr("y", -margin.top / 2)
                .attr("text-anchor", "middle")
                .style("font-size", "18px")
                .style("font-weight", "bold")
                .style("fill", "#2c3e50")
                .text("Price Distribution Box Plot by Location");

            // Add legend
            svg.append("text")
                .attr("class", "legend")
                .attr("x", width - 200)
                .attr("y", 10)
                .text("* Box shows Q1 to Q3 range");

            svg.append("text")
                .attr("class", "legend")
                .attr("x", width - 200)
                .attr("y", 30)
                .text("* White line is the median");

            svg.append("text")
                .attr("class", "legend")
                .attr("x", width - 200)
                .attr("y", 50)
                .text("* Whiskers extend to min/max values");

            svg.append("text")
                .attr("class", "legend")
                .attr("x", width - 200)
                .attr("y", 70)
                .text("* Points represent individual transactions");
        });
    </script>
</body>
</html>